---
alwaysApply: false
---

## Nutrition Android App — Quick Context

High-level notes to help an LLM (or a developer) locate things fast and build an APK without reading the whole codebase.

### Build APK
- **Prereqs**: Android Studio Giraffe/Koala+ (AGP 8.x), JDK 17, Android SDK 34.
- **From CLI**:
  - Debug APK: `./gradlew assembleDebug`
  - Install on device/emulator: `./gradlew installDebug`
  - Unsigned release APK: `./gradlew assembleRelease`
    - To produce a signed release, add a signing config in `android_app/app/build.gradle` and set it on `buildTypes.release`.
- **From Android Studio**: Open the `android_app/` module directory, then Build > Make Project or Build APK(s).

Notes:
- A debug keystore is generated automatically if missing (see `android_app/app/build.gradle` `preBuild` task).
- Min SDK 24, Target SDK 34. Application ID: `com.nutrition.app`.

### Quick: build and install on a connected phone (USB)

```bash
cd android_app
# Build and install the debug variant on the connected device
./gradlew installDebug

# Launch the app
adb shell monkey -p com.nutrition.app -c android.intent.category.LAUNCHER 1
```

If `adb` cannot find a device, ensure Developer options and USB debugging are enabled on the phone. Use `adb devices` to verify.

### Backend/API Base URL
- Defined in `android_app/app/src/main/java/com/nutrition/app/di/AppModule.kt` inside `provideRetrofit(...)` via `.baseUrl("...")`.
- Default: `https://nutrition-tbdo.onrender.com/`.
- For emulator + local backend use: `http://10.0.2.2:<port>/`.
- Cleartext traffic is allowed in `AndroidManifest.xml` (`android:usesCleartextTraffic="true"`).

### Key Entry Points
- `android_app/app/src/main/AndroidManifest.xml`: app config, permissions (Camera, Internet), `MainActivity` launcher, `NutritionApplication`.
- `android_app/app/src/main/java/com/nutrition/app/MainActivity.kt`: sets up Compose navigation and enqueues periodic `WorkManager` sync.
- `android_app/app/src/main/java/com/nutrition/app/NutritionApplication.kt`: Hilt application class (if present in codebase).

### Dependency Injection (Hilt)
- `android_app/app/src/main/java/com/nutrition/app/di/`
  - `AppModule.kt`: Room DB, OkHttp, Retrofit (base URL), repository wiring, `WorkManager`.
  - `NetworkModule.kt`: Creates `NutritionApi` from the Retrofit instance (named `"NutritionApi"`).
  - `PlotsModule.kt`: Creates `PlotsApiService` from the same Retrofit instance.

### UI & Navigation (Jetpack Compose)
- `android_app/app/src/main/java/com/nutrition/app/ui/`
  - `dailylog/`: `DailyLogScreen` and view model for the home/log view.
  - `foodentry/`: `FoodEntryRoute`, `FoodEntryForm`, barcode scanning (`BarcodeScanActivity`) with CameraX + ML Kit.
  - `sportentry/`: sport entry route and form.
  - `customfood/`: create/view custom foods.
  - `plots/`: charts (MPAndroidChart) and date range utilities.
  - `theme/`: colors, typography, theme setup.

### Data Layer & Sync
- `android_app/app/src/main/java/com/nutrition/app/data/`: repositories, Retrofit service interfaces, and Room entities/DAOs (see DAOs provided in `AppModule`).
- `android_app/app/src/main/java/com/nutrition/app/sync/SyncWorker.kt`: periodic background sync via `WorkManager` scheduled in `MainActivity`.

### Utilities
- `android_app/app/src/main/java/com/nutrition/app/util/`: helpers such as `DateConverter`.

### Resources
- `android_app/app/src/main/res/`: layouts (for Camera preview), drawables (marker bg), strings, themes, and `xml/` for backup/data extraction rules.

### Gradle & Tooling
- Project settings: `android_app/settings.gradle`, root `android_app/build.gradle` (AGP/Kotlin/Hilt/KSP), module `android_app/app/build.gradle` (Compose, CameraX, ML Kit, Room, WorkManager, Retrofit, MPAndroidChart).
- Compose is enabled with BOM; Kotlin compiler extension set in `composeOptions`.

### Tests
- Instrumented UI tests: `android_app/app/src/androidTest/java/com/nutrition/app/ui/...`
  - Run on device/emulator: `./gradlew connectedDebugAndroidTest`.
- Unit tests (if present under `test/`): `./gradlew testDebugUnitTest`.

### Common Tasks
- Update backend URL: edit `AppModule.provideRetrofit` `.baseUrl(...)` and rebuild.
- Add a new screen: place Composables under `ui/<feature>/` and add a route in `MainActivity` `NavHost`.
- Add an API: define service interface under `data/remote`, provide it in a DI module using the named Retrofit, inject into a repository/view model.

### Deploy (Render)

- Pushes to the configured branch on Render trigger an automatic rebuild/redeploy of the backend. In this repo, the default branch is `master`.
- Service URL: `https://nutrition-tbdo.onrender.com/` (health: `/api/v1/health`).
- Verify plots after deploy (weight will 404 if no observed weights exist):
  - `curl -sS -f https://nutrition-tbdo.onrender.com/api/v1/plots/weight | jq '.W_obs | length' || echo "No observed weights (404)"`
  - `curl -sS https://nutrition-tbdo.onrender.com/api/v1/plots/metabolism | jq '.M_base | length'`
  - `curl -sS https://nutrition-tbdo.onrender.com/api/v1/plots/energy-balance | jq '.calories_unnorm | length'`
  - Energy-balance is also available at `/api/v1/energy-balance`.
- If a series returns 0 points, the mobile app shows "Nothing found" and no series are drawn.
- You can rebuild the in-memory plot cache:
  - `curl -X POST https://nutrition-tbdo.onrender.com/api/v1/plots/rebuild`


### Plots: data sources and normalization

- **Data sources**
  - Web/Android plots call the API (`/api/v1/plots/*`), which builds series from DB aggregates and the model.
  - The PNG (`model_analysis_plots.png`) is generated from `data/final_results.csv` produced during training.

- **Behavior**
  - `GET /api/v1/plots/weight` returns observed weights only when they exist in the DB; it returns 404 if none exist (no fallback).
  - `GET /api/v1/plots/energy-balance` is also exposed at `/api/v1/energy-balance` (alias).

- **Normalization**
  - DB `calories` and `sport` values are absolute kcal; the server does not de-normalize them.
  - `M_base` in API responses is already in kcal/day.
  - The PNG de-normalizes using `models/best_params.json` (for training-time tensors); this differs from the API path, which operates on DB absolutes.

- **Time axis**
  - API `time_index` values are epoch milliseconds (for time charts).
  - The PNG uses a simple day index; values align but x-axes differ.

- **Troubleshooting**
  - If values appear inconsistent, the usual cause is different underlying datasets (DB vs. training CSV). Ensure you’re comparing the same date ranges and data sources.


## Backend model inference (low-memory on Render)

The API serves plots by predicting daily metabolism/weight adjustment using a small GRU model. Production runs in a 512 MB container, so the model is served with a torch-free path by default.

- **Runtime selection**:
  - If `models/recurrent_model_np.npz` exists, the API uses a NumPy-only backend and does not import PyTorch (saves ~150–200 MB RAM).
  - If the `.npz` is missing, it lazily imports PyTorch on first use, loads `models/recurrent_model.pth`, sets single-threaded backends, and applies dynamic quantization for CPU.
  - The model is loaded lazily: on first prediction or during a background warm-up at startup. You can also trigger a reload via `POST /api/v1/predict/reload-model`.

- **Files**:
  - `models/recurrent_model.pth`: PyTorch state dict.
  - `models/recurrent_model_np.npz`: NumPy weights for torch-free inference.
  - `models/best_params.json`: normalization stats required by both backends.

- **Export the NumPy weights**:
  - Training already exports both `.pth` and `.npz`.

- **Low-thread CPU settings**:
  - Set in code at process start, and in `render.yaml` env variables: `OMP_NUM_THREADS=1`, `OPENBLAS_NUM_THREADS=1`, `MKL_NUM_THREADS=1`, `NUMEXPR_NUM_THREADS=1`, `MKL_THREADING_LAYER=SEQUENTIAL`, `MALLOC_ARENA_MAX=2`.

- **Verify predictions/plots after deploy**:
  - Health: `curl -sS $BASE/api/v1/health`
  - Debug (should show non-zero `final_rows` and expected columns): `curl -sS $BASE/api/v1/plots/debug | jq .`
  - Latest prediction (drives plots): `curl -sS $BASE/api/v1/predict/latest | jq .`
  - Metabolism data: `curl -sS "$BASE/api/v1/plots/metabolism?days=30" | jq '.M_base | length'`

- **Operational notes**:
  - You can hot-reload weights: `POST /api/v1/predict/reload-model`.
  - If you truly never need PyTorch in production, you can omit it from the image; the app will use NumPy.


### Populate the Production Database (Neon)

This repo includes scripts and data to fill the production database with food definitions and daily logs parsed from your CSVs.

- Key files:
  - `data/variables.csv`: food nutrient data per 100g (source of truth for foods)
  - `data/processed_journal.csv`: journal of daily food formulas and weights (column `Pds` holds observed weight)
  - `app/db/populate_db.py`: populates `foods`, `food_logs`, `sport_activities`, and ingests observed weights into `weight_logs`
  - `verify_day_vs_db.py`: compares CSV totals vs DB for a given date

- One-time setup (recommended):
  ```bash
  python3 -m venv .venv
  . .venv/bin/activate
  python -m pip install -r requirements.txt
  ```

- DB configuration source of truth:
  - The default `DATABASE_URL` is defined in code in `app/core/config.py` (`Settings.DATABASE_URL`).
  - Settings are loaded via `pydantic-settings`, which reads `.env` and `.env.local` automatically. Any value set in the environment or these files will override the in-code default.
  - For docker-compose, set `DATABASE_URL=postgresql://user:password@db:5432/nutrition_db` in a `.env` file so containers can talk to the Postgres service at host `db`. If you run Alembic from the host, ensure `DATABASE_URL` points to Neon (not `db`/localhost) to avoid connection errors.

- Prepare CSVs (if you haven’t already processed the Excel journal):
  ```bash
  . .venv/bin/activate
  PYTHONPATH=. python process_nutrition_journal.py
  # Produces data/processed_journal.csv and data/variables.csv
  ```

- Populate tables (using the in-code Neon default or your override):
  ```bash
  . .venv/bin/activate
  # .env/.env.local overrides are picked up automatically
  # Option A (recommended): module execution avoids import issues
  PYTHONPATH=. python -m app.db.populate_db
  # Option B: direct script execution
  PYTHONPATH=. python app/db/populate_db.py
  ```
  Notes:
  - The script first (re)populates `foods` from `data/variables.csv`.
  - It then parses each `Nourriture` formula in `data/processed_journal.csv` and inserts rows in `food_logs`.
  - It also parses the `Sport` expressions from the same CSV, evaluates calories using `sport_formulas.py` (with the day’s weight), infers activity name and duration, and inserts rows in `sport_activities`.
  - It ingests observed weights from `data/processed_journal.csv` column `Pds` into `weight_logs` (clears and reinserts for the dummy user on each run).

  - Sports-only run (re-fill only sports without touching foods/logs):
    ```bash
    DATABASE_URL='<neon-url>' PYTHONPATH=. python -c "from app.db.populate_db import populate_sport_activities_table, verify_population; populate_sport_activities_table(); verify_population()"
    ```

- Alternative: populate/verify against the local docker DB (inside the container):
  ```bash
  # Start Postgres
  docker-compose up -d db
  # Run populate against the compose DB (uses .env DATABASE_URL with host "db")
  docker-compose run --rm -e PYTHONPATH=/app backend python app/db/populate_db.py
  # Verify counts inside the container
  docker-compose run --rm -e PYTHONPATH=/app backend python app/verify_db.py
  ```

- Verify population (host, using Neon default or your override):
  ```bash
  PYTHONPATH=. python app/verify_db.py
  # Or per-day comparison (example date):
  PYTHONPATH=. python verify_day_vs_db.py --date 2025-05-03
  ```

- Quick weight-logs sanity check:
  ```bash
  PYTHONPATH=. python - <<'PY'
  from app.db.database import SessionLocal
  from app.db.models import WeightLog
  s=SessionLocal(); print('weight_logs count =', s.query(WeightLog).count()); s.close()
  PY
  ```

- Troubleshooting:
  - If you see `Could not parse SQLAlchemy URL`: ensure an effective `DATABASE_URL` is available (in-code default, env var, or `.env(.local)`).
  - If you see `could not translate host name "db"`: you're running from the host while pointing to the compose DB. Either run the command inside the container (see alternative above) or override `DATABASE_URL` to Neon.
  - If imports fail (e.g., `ModuleNotFoundError: utils` or `pydantic_settings`), ensure the venv is activated and prefer module execution with an explicit project root on `PYTHONPATH`:
    - `PYTHONPATH=. python -m app.db.populate_db`
  - If `data/processed_journal.csv` is missing, run: `PYTHONPATH=. python process_nutrition_journal.py` first.
  - If a populate command appears to “hang”: it’s usually waiting on a DB host that isn’t reachable (e.g., `db` from docker-compose when running on the host). Quick check:
    ```bash
    DATABASE_URL='<neon-url>' PYTHONPATH=. python app/verify_db.py
    ```
    If this works, re-run the populate command with `DATABASE_URL` set to Neon or run the populate inside the container so `db` resolves.
  - If `pip install` fails with an externally-managed environment (PEP 668), create and use a virtualenv (as shown above) instead of system Python.
  - If `/api/v1/plots/weight` returns 404: there are no observed weights in the DB yet. Run the populate script to ingest `Pds` into `weight_logs`, or add a weight logging endpoint/UI to record weights.

### Android Emulator (AVD) setup

- **Install SDK tools (one-time)**
  ```bash
  export ANDROID_SDK_ROOT=$HOME/Android/Sdk ANDROID_HOME=$ANDROID_SDK_ROOT
  mkdir -p "$ANDROID_SDK_ROOT"
  yes | sdkmanager --sdk_root="$ANDROID_SDK_ROOT" \
    "cmdline-tools;latest" "platform-tools" "emulator" \
    "platforms;android-34" "build-tools;34.0.0" \
    "system-images;android-34;default;x86_64"
  yes | sdkmanager --licenses --sdk_root="$ANDROID_SDK_ROOT"
  ```

- **Create an AVD (Android 34, x86_64)**
  ```bash
  echo no | avdmanager create avd -n nutrition_avd \
    -k "system-images;android-34;default;x86_64" -c 2048M --force
  ```

- **Start the emulator** (headless example)
  ```bash
  $ANDROID_SDK_ROOT/emulator/emulator -avd nutrition_avd \
    -no-window -no-boot-anim -gpu swiftshader_indirect -no-snapshot
  ```

- **Install and launch the app**
  ```bash
  cd android_app && ./gradlew installDebug
  adb shell monkey -p com.nutrition.app -c android.intent.category.LAUNCHER 1
  ```

- **Useful commands**
  - List devices: `adb devices`
  - View logs: `adb -s <emulator-serial> logcat`
  - Stop emulator: `adb -s <emulator-serial> emu kill`

- **Backend note**
  - Default base URL is production (set in `android_app/app/src/main/java/com/nutrition/app/di/AppModule.kt`). Actions in the emulator will affect prod data.
  - To use a local backend from the emulator, set `.baseUrl("http://10.0.2.2:<port>/")` in `AppModule.provideRetrofit` and rebuild.


## Backend performance & DB tuning

- Index-friendly day queries:
  - Replace `DATE(logged_at)` filters with a UTC range: `[day_start, day_end)`. This enables index usage on `logged_at`.
- Composite indexes (added):
  - `food_logs(user_id, logged_at)` and `sport_activities(user_id, logged_at)`.
  - Apply: `. .venv/bin/activate && alembic upgrade head` (uses Neon by default).
- Verify indexes exist (example via psql):
  - `\d+ food_logs` and `\d+ sport_activities` should list `ix_*_user_id_logged_at`.
- SQLAlchemy engine (Neon):
  - We enable `pool_pre_ping=True` and `pool_recycle=300` in `app/db/database.py` to avoid stale connections.
- Alembic config notes:
  - `migrations/env.py` uses `settings.DATABASE_URL`. Ensure it points to Neon when running migrations locally. If you previously had Alembic trying `localhost`/`db`, update `.env` or export `DATABASE_URL` to Neon, then rerun `alembic upgrade head`.
